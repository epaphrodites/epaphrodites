#!/bin/bash

# Couleurs pour le terminal
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[1;34m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# Chemins attendus
TRAIN_SCRIPT="bin/epaphrodites/chatBot/ragFaissModel/train_index.py"
TEXT_DIR="static/docs/base-data"
VECTOR_DIR="bin/database/datas/vector-data"
INDEX_FILE="${VECTOR_DIR}/faiss_index.idx"
METADATA_FILE="${VECTOR_DIR}/chunks_metadata.npy"

echo -e "${BLUE}üîç √âtape 1 : V√©rification de la pr√©sence du script d'entra√Ænement...${NC}"
if [ ! -f "$TRAIN_SCRIPT" ]; then
    echo -e "${RED}‚ùå Le fichier $TRAIN_SCRIPT est introuvable ! Assurez-vous qu'il existe.${NC}"
    exit 1
fi
echo -e "${GREEN}‚úÖ train_index.py trouv√©.${NC}"
echo ""

echo -e "${BLUE}üìÅ √âtape 2 : V√©rification des dossiers requis...${NC}"
if [ ! -d "$TEXT_DIR" ]; then
    echo -e "${RED}‚ùå Dossier manquant : $TEXT_DIR${NC}"
    exit 1
else
    echo -e "${GREEN}‚úÖ Dossier texte trouv√© : $TEXT_DIR${NC}"
fi

# Cr√©ation du dossier vector-data s'il n'existe pas
if [ ! -d "$VECTOR_DIR" ]; then
    echo -e "${YELLOW}‚ö†Ô∏è Dossier manquant : $VECTOR_DIR - Cr√©ation du dossier...${NC}"
    mkdir -p "$VECTOR_DIR"
    if [ $? -eq 0 ]; then
        echo -e "${GREEN}‚úÖ Dossier vectoriel cr√©√© : $VECTOR_DIR${NC}"
    else
        echo -e "${RED}‚ùå Impossible de cr√©er le dossier : $VECTOR_DIR${NC}"
        exit 1
    fi
else
    echo -e "${GREEN}‚úÖ Dossier vectoriel trouv√© : $VECTOR_DIR${NC}"
fi
echo ""

echo -e "${BLUE}‚úÇÔ∏è √âtape 3 : D√©coupage des documents en petits blocs (chunks)...${NC}"
sleep 1
echo ""

echo -e "${BLUE}üß† √âtape 4 : G√©n√©ration des vecteurs d'embedding avec SentenceTransformer...${NC}"
sleep 1
echo ""

echo -e "${BLUE}üì¶ √âtape 5 : Construction de l'index FAISS et sauvegarde des donn√©es...${NC}"
sleep 1
echo ""

echo -e "${GREEN}üöÄ Lancement de l'entra√Ænement...${NC}"

# Augmenter la taille de la pile pour √©viter les segfaults
ulimit -s 65536

# Ex√©cution avec v√©rification d'erreur
python3 "$TRAIN_SCRIPT"
PYTHON_EXIT_CODE=$?

# V√©rification suppl√©mentaire des fichiers g√©n√©r√©s
if [ $PYTHON_EXIT_CODE -eq 0 ] && [ -f "$INDEX_FILE" ] && [ -f "$METADATA_FILE" ]; then
    echo ""
    echo -e "${GREEN}‚úÖ Entra√Ænement termin√© avec succ√®s.${NC}"
    echo -e "${GREEN}üìÅ Les fichiers suivants ont √©t√© g√©n√©r√©s dans '${VECTOR_DIR}':${NC}"
    echo -e "${YELLOW}- faiss_index.idx"
    echo -e "- chunks_metadata.npy${NC}"
else
    echo ""
    echo -e "${RED}‚ùå Une erreur est survenue pendant l'entra√Ænement.${NC}"
    
    if [ $PYTHON_EXIT_CODE -eq 139 ] || [ $PYTHON_EXIT_CODE -eq 11 ]; then
        echo -e "${YELLOW}‚ö†Ô∏è Erreur de segmentation d√©tect√©e (Segmentation fault).${NC}"
        echo -e "${YELLOW}üí° Essayez les solutions suivantes :${NC}"
        echo -e "  - Augmenter la m√©moire disponible"
        echo -e "  - R√©duire la taille des batchs (BATCH_SIZE) dans train_index.py"
        echo -e "  - Utiliser un mod√®le d'embedding plus l√©ger"
    fi
    
    # V√©rification des fichiers pour plus d'informations sur l'√©tat
    if [ -f "$INDEX_FILE" ]; then
        echo -e "${YELLOW}‚ÑπÔ∏è Le fichier d'index existe mais pourrait √™tre incomplet.${NC}"
    fi
    if [ -f "$METADATA_FILE" ]; then
        echo -e "${YELLOW}‚ÑπÔ∏è Le fichier de m√©tadonn√©es existe mais pourrait √™tre incomplet.${NC}"
    fi
    
    exit 1
fi